# @bibliogost/api

tRPC API для обработки библиографических ссылок с поддержкой ГОСТ 2008 и ГОСТ 2018.

## Функционал

### Citation Router

Роутер для обработки "грязного" ввода библиографических ссылок.

#### `citation.process`

Основной метод для обработки библиографических ссылок.

**Входные параметры:**

- `text` (string, обязательный) - текст с библиографическими ссылками
- `style` ('gost-2008' | 'gost-2018', по умолчанию 'gost-2018') - стиль форматирования
- `grobidUrl` (string, по умолчанию 'http://localhost:8070') - URL GROBID сервера

**Выходные данные:**

```typescript
{
  results: Array<{
    original: string; // Исходная ссылка
    formatted: string; // Отформатированная ссылка
    warnings: string[]; // Предупреждения о недостающих полях
    success: boolean; // Успешность обработки
  }>;
  totalProcessed: number; // Всего обработано ссылок
  totalSuccess: number; // Успешно обработано
  totalWarnings: number; // Всего предупреждений
}
```

**Шаги обработки:**

1. Очистка текста от "мусора":
   - Удаление нумерации: `1.`, `2.`, `[1]`, `*`
   - Удаление символов: `▶`, `•`, `→`, `»`
   - Замена длинных пробелов на одинарные
   - Удаление кавычек вокруг названий
   - Замена "et al." и "и соавт." на "и др."
   - Добавление точки в конце, если её нет
2. Разбивка текста на строки по `\n`
3. Автоматическое добавление даты обращения для URL: `(дата обращения: DD.MM.YYYY)`
4. Парсинг каждой строки через GROBID
5. Конвертация в формат citeproc-js
6. Форматирование по выбранному стилю ГОСТ
7. Проверка недостающих полей (год, страницы, автор)

**Пример использования:**

```typescript
const result = await trpc.citation.process.mutate({
  text: `1. Иванов И.И. Название статьи // Журнал. 2020. Т. 1. № 2. С. 10-20.
2. Петров П.П. Книга. М.: Издательство, 2019. 300 с.`,
  style: "gost-2018",
});
```

#### `citation.clean`

Очищает текст без полной обработки (для предпросмотра).

**Входные параметры:**

- `text` (string) - текст для очистки

**Выходные данные:**

```typescript
{
  cleaned: string;           // Очищенный текст
  references: string[];      // Массив отдельных ссылок
}
```

**Пример использования:**

```typescript
const result = await trpc.citation.clean.query({
  text: '1. Иванов И.И. "Название" // Журнал. 2020.',
});
// result.cleaned: "Иванов И.И. Название // Журнал. 2020."
```

#### `citation.checkGrobid`

Проверяет доступность GROBID сервера.

**Входные параметры:**

- `url` (string, по умолчанию 'http://localhost:8070') - URL GROBID сервера

**Выходные данные:**

```typescript
{
  available: boolean; // Доступность сервера
  message: string; // Сообщение о статусе
}
```

**Пример использования:**

```typescript
const result = await trpc.citation.checkGrobid.query({
  url: "http://localhost:8070",
});
```

## Настройка GROBID

Для работы функционала необходим запущенный GROBID сервер.

### Установка через Docker:

```bash
docker pull lfoppiano/grobid:0.8.0
docker run -t --rm -p 8070:8070 lfoppiano/grobid:0.8.0
```

### Проверка работы:

```bash
curl http://localhost:8070/api/isalive
```

## Особенности обработки

### Пропуск отсутствующих полей

API **НЕ** добавляет `[б.г.]` или другие заглушки для отсутствующих полей. Вместо этого:

- Поля просто пропускаются
- Генерируется предупреждение в массиве `warnings`

### Обработка URL

Для ссылок с URL автоматически добавляется дата обращения в формате:

```
URL: https://example.com (дата обращения: 23.11.2025)
```

### Обработка авторов

- "et al." → "и др."
- "и соавт." → "и др."

## Зависимости

- `axios` - для HTTP запросов к GROBID
- `citeproc` - для форматирования библиографии
- `zod` - для валидации входных данных
